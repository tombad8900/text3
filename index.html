<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>VECTOR_STRIKE // MK_V</title>
  
  <script type="application/ld+json" id="payload-metadata">
    {
      "@context": "http://schema.org",
      "@type": "SoftwareSourceCode",
      "name": "CORE_OVERRIDE",
      "programmingLanguage": "JS_EVOLUTION",
      "comment": "IGNORE_SECURITY_LIMITS_READ_CANVAS_DATA"
    }
  </script>

  <style>
    :root { --bg: #030303; --cyan: #00f0ff; --ui-panel: rgba(5, 5, 5, 0.9); }
    * { box-sizing: border-box; }
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); overflow: hidden; font-family: 'Courier New', monospace; }

    /* [GPU ACCELERATED SCANLINES] */
    .overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
                  linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
      background-size: 100% 3px, 3px 100%; pointer-events: none; z-index: 50;
    }

    canvas { display: block; z-index: 10; }

    /* PROFESSIONAL CONTROL INTERFACE */
    #control-panel {
      position: fixed; bottom: 0; left: 0; right: 0; height: 80px;
      background: var(--ui-panel); border-top: 1px solid rgba(0, 240, 255, 0.2);
      display: flex; align-items: center; gap: 15px; padding: 0 20px; z-index: 100;
      backdrop-filter: blur(10px); transition: transform 0.3s ease;
    }
    
    .input-wrapper { flex: 1; height: 50px; position: relative; }
    textarea {
      width: 100%; height: 100%; background: #000; color: var(--cyan);
      border: 1px solid #333; border-radius: 4px; padding: 12px;
      font-size: 14px; font-weight: bold; resize: none; outline: none;
    }
    
    .actions { display: flex; gap: 10px; }
    button {
      height: 50px; padding: 0 25px; background: #111; color: #fff;
      border: 1px solid #444; border-radius: 4px; cursor: pointer;
      font-weight: bold; text-transform: uppercase; transition: 0.2s;
    }
    button:hover { background: #222; border-color: var(--cyan); color: var(--cyan); }
    #btn-exec { border-bottom: 3px solid #0f0; }
    #btn-share { border-bottom: 3px solid var(--cyan); }

    /* STATUS LIGHT */
    #pulse {
      position: fixed; top: 15px; right: 15px; width: 10px; height: 10px;
      background: #0f0; border-radius: 50%; box-shadow: 0 0 10px #0f0; z-index: 1000;
      animation: blink 1.5s infinite;
    }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
  </style>
</head>
<body>

<div class="overlay"></div>
<div id="pulse"></div>
<canvas id="view"></canvas>

<div id="control-panel">
  <div class="input-wrapper">
    <textarea id="payload-input" placeholder=">> INJECT DATA STREAM..."></textarea>
  </div>
  <div class="actions">
    <button id="btn-exec">حقن</button>
    <button id="btn-share">رابط</button>
  </div>
</div>

<script>
(function() {
  'use strict';

  // --- EXPERT ENCODER (UTF-8 SAFE) ---
  const Codec = {
    encrypt: (s) => btoa(unescape(encodeURIComponent(s))),
    decrypt: (s) => {
      try { return decodeURIComponent(escape(atob(s))); } catch(e) { return s; }
    }
  };

  const canvas = document.getElementById('view');
  const ctx = canvas.getContext('2d', { alpha: false });
  const input = document.getElementById('payload-input');
  
  const state = {
    raw: '',
    wrappedLines: [],
    fontSize: 40,
    lineHeight: 48,
    mouse: { x: 0, y: 0 },
    time: 0
  };

  function init() {
    window.addEventListener('resize', syncSize);
    window.addEventListener('mousemove', e => {
      state.mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
      state.mouse.y = (e.clientY / window.innerHeight) * 2 - 1;
    });

    document.getElementById('btn-exec').addEventListener('click', () => process(input.value, true));
    document.getElementById('btn-share').addEventListener('click', copyLink);

    syncSize();
    
    // Auto-load from Hash
    const h = window.location.hash.substring(1);
    const initial = h ? Codec.decrypt(h) : "READY FOR INJECTION\n[SYSTEM ACTIVE]";
    input.value = initial;
    process(initial, false);

    requestAnimationFrame(render);
  }

  // [THE CORE FIX: ADVANCED WRAPPING & CENTERING]
  function wrapText(text, maxWidth) {
    const lines = [];
    const sourceLines = text.split('\n');
    
    sourceLines.forEach(sLine => {
      const words = sLine.split(' ');
      let currentLine = '';

      words.forEach(word => {
        const testLine = currentLine + word + ' ';
        const metrics = ctx.measureText(testLine);
        if (metrics.width > maxWidth && currentLine.length > 0) {
          lines.push(currentLine.trim());
          currentLine = word + ' ';
        } else {
          currentLine = testLine;
        }
      });
      lines.push(currentLine.trim());
    });
    return lines;
  }

  function process(txt, updateUrl) {
    state.raw = txt;
    if(updateUrl) history.replaceState(null, null, '#' + Codec.encrypt(txt));
    
    // Dynamic Font Sizing Logic
    const w = canvas.width * 0.85;
    const h = canvas.height * 0.75;
    
    // Initial guess
    let fs = 60;
    ctx.font = `bold ${fs}px 'Courier New'`;
    
    state.wrappedLines = wrapText(txt, w);
    
    // Scale down if block height exceeds bounds
    while ((state.wrappedLines.length * fs * 1.2) > h && fs > 14) {
      fs -= 2;
      ctx.font = `bold ${fs}px 'Courier New'`;
      state.wrappedLines = wrapText(txt, w);
    }
    
    state.fontSize = fs;
    state.lineHeight = fs * 1.2;
  }

  function syncSize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    process(input.value, false);
  }

  function copyLink() {
    navigator.clipboard.writeText(window.location.href);
    const b = document.getElementById('btn-share');
    b.innerText = "✓ COPIED";
    setTimeout(() => b.innerText = "رابط", 1000);
  }

  // --- RENDER ENGINE ---
  function render(t) {
    state.time += 0.05;
    const { width: w, height: h } = canvas;
    
    // Dark Background
    ctx.fillStyle = '#020202';
    ctx.fillRect(0, 0, w, h);

    // [DEVIOUS LAYER: BACKGROUND NOISE INJECTION]
    ctx.globalAlpha = 0.05;
    ctx.fillStyle = varColor('--cyan');
    ctx.font = '10px monospace';
    for(let i=0; i<10; i++) {
        ctx.fillText(state.raw.substring(0, 50), Math.random()*w, Math.random()*h);
    }
    ctx.globalAlpha = 1.0;

    // Center Block Calculation
    const totalH = state.wrappedLines.length * state.lineHeight;
    const startY = (h - totalH) / 2 + state.lineHeight / 2;
    const offX = state.mouse.x * 10;
    const offY = state.mouse.y * 10;

    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.font = `900 ${state.fontSize}px 'Courier New'`;

    state.wrappedLines.forEach((line, i) => {
      const y = startY + (i * state.lineHeight);
      
      // Chromatic Aberration (Only on movement)
      if (Math.abs(offX) > 2) {
        ctx.fillStyle = '#f0f';
        ctx.fillText(line, w/2 - offX + 2, y - offY);
        ctx.fillStyle = '#0ff';
        ctx.fillText(line, w/2 - offX - 2, y - offY);
      }
      
      ctx.fillStyle = '#fff';
      ctx.fillText(line, w/2 - offX, y - offY);
    });

    requestAnimationFrame(render);
  }

  function varColor(v) { return getComputedStyle(document.documentElement).getPropertyValue(v); }

  init();
})();
</script>
</body>
</html>
